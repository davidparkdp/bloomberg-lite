<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Bloomberg Lite</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
html, body {
    height: 100%;
    margin: 0;
    overflow: hidden;
    background: #0a0a0a;
    color: #00ffcc;
    font-family: monospace;
    font-size: 12.5px;
}

body {
    display: flex;
    flex-direction: column;
}

.header {
    flex-shrink: 0;
    display: flex;
    align-items: center;
    color: orange;
    padding: 5px 10px;
    border-bottom: 1px solid #333;
    background: #111;
}
.header-title { font-size: 13px; font-weight: bold; letter-spacing: 1.5px; }
.header-time  { color: #888; font-size: 10px; margin-left: auto; }

.tabs {
    flex-shrink: 0;
    display: flex;
    gap: 2px;
    padding: 3px 10px;
    background: #111;
    border-bottom: 1px solid #333;
}
.tab {
    padding: 3px 12px;
    cursor: pointer;
    border: 1px solid #444;
    color: #888;
    background: transparent;
    font-size: 10.5px;
    letter-spacing: 0.8px;
    transition: all .12s;
}
.tab.active { border-color: orange; color: orange; background: rgba(255,165,0,.08); }
.tab:hover:not(.active) { color: #ccc; border-color: #666; }

#pages {
    flex: 1;
    display: flex;
    min-height: 0;
    overflow: hidden;
}
.page {
    display: none;
    flex: 1;
    padding: 4px 6px;
    overflow: hidden;
}
.page.active {
    display: flex;
    flex-wrap: wrap;
    align-items: stretch;          /* makes columns same height */
    gap: 6px;
}

.col {
    flex: 1 1 240px;
    min-width: 240px;
    max-width: 340px;
    display: flex;                  /* flex container */
    flex-direction: column;         /* stack groups + rows vertically */
    overflow: hidden;
    padding: 0 4px;
    border-right: 1px solid #1a1a1a;
}
.col:last-child { border-right: none; }

/* This pushes content to top and fills remaining space at bottom */
.col::after {
    content: "";
    flex-grow: 1;                   /* fills empty space → aligns bottoms */
    min-height: 0;
}

.group {
    color: orange;
    margin: 6px 0 2px 0;
    font-size: 10px;
    letter-spacing: 0.7px;
    border-bottom: 1px solid #222;
    padding-bottom: 1px;
    text-transform: uppercase;
    line-height: 1.1;
}
.group:first-of-type { margin-top: 3px; }

.row {
    display: grid;
    grid-template-columns: 46px 88px 64px 56px 54px 22px;
    padding: 1px 0;
    font-size: 12px;
    line-height: 1.35;
    border-bottom: 1px solid #0f0f0f;
    align-items: center;
    min-height: 17px;
}
.row:hover { background: #141414; }

.cell-ticker { font-weight: bold; color: #ffb300; cursor: pointer; }
.cell-name {
    color: #ffb300;
    font-size: 10.8px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    opacity: 0.88;
}
.cell-price { text-align: right; }
.cell-chg   { text-align: right; }
.cell-pct   { text-align: right; }
.cell-age   { text-align: right; font-size: 9px; color: #ffb300; opacity: 0.65; }

.green { color: #00e676; }
.red   { color: #ff5252; }

.statusbar {
    flex-shrink: 0;
    background: #111;
    border-top: 1px solid #222;
    padding: 2px 10px;
    font-size: 9.5px;
    color: #555;
    display: flex;
    gap: 14px;
}
.statusbar span { color: #555; }
.status-warn { color: #ffaa00 !important; }

/* Tighter on smaller screens */
@media (max-height: 820px) {
    .row { font-size: 11.4px; min-height: 15px; }
    .cell-name { font-size: 10px; }
    .cell-age { font-size: 8.5px; }
    .group { font-size: 9.5px; margin: 5px 0 1px; }
}

@media (max-height: 680px) {
    .row { font-size: 10.8px; min-height: 14px; grid-template-columns: 42px 80px 58px 52px 50px 20px; }
    .cell-name { font-size: 9.5px; }
    .cell-age { font-size: 8px; }
    .group { font-size: 9px; margin: 4px 0 0; }
}
</style>
</head>
<body>
<div class="header">
    <div class="header-title">◆ BLOOMBERG LITE</div>
    <div class="header-time" id="clock"></div>
</div>
<div class="tabs" id="tabs"></div>
<div id="pages"></div>
<div class="statusbar">
    <span id="status">Loading…</span>
    <span id="counter"></span>
</div>

<script>
const API_KEY       = "d6atqi1r01qnr27isiq0d6atqi1r01qnr27isiqg";
const CALL_DELAY_MS = 1200;
const PAUSE_ON_429  = 65000;
const NUM_COLS      = 5;
const SHEET_URL     = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT46q9pwRZMT27tLH6taYNgIYXFPkLdnjOhv3KqqGJGJY_Dn1SJ6yI4v1jaODaHy33TwbM-L5z14UWF/pub?gid=0&single=true&output=csv";

function parseCSV(text) {
    return text.trim().split("\n").map(line => {
        const fields = [];
        let cur = "", inQ = false;
        for (const ch of line) {
            if (ch === '"') inQ = !inQ;
            else if (ch === ',' && !inQ) { fields.push(cur.trim()); cur = ""; }
            else cur += ch;
        }
        fields.push(cur.trim());
        return fields;
    });
}

async function loadCSV(url) {
    const r = await fetch(url);
    return parseCSV(await r.text());
}

const quoteStore = {};
const tickerMeta = {};
let masterList = [];
let numPages = 0;

const sleep = ms => new Promise(r => setTimeout(r, ms));

function setStatus(msg, warn=false) {
    const el = document.getElementById("status");
    el.textContent = msg;
    el.className = warn ? "status-warn" : "";
}
function setCounter(i, n) {
    document.getElementById("counter").textContent = `${i} / ${n}`;
}
function updateClock() {
    const now = new Date();
    document.getElementById("clock").textContent =
        now.toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric"}) +
        "  " + now.toLocaleTimeString("en-US",{hour12:false});
}
setInterval(updateClock, 1000);
updateClock();

function ageLabel(ts) {
    if (!ts) return "";
    const s = Math.floor((Date.now()-ts)/1000);
    if (s < 60)   return s+"s";
    if (s < 3600) return Math.floor(s/60)+"m";
    return Math.floor(s/3600)+"h";
}

async function buildMasterList() {
    masterList = [];
    const rows = await loadCSV(SHEET_URL);
    const maxCols = Math.max(...rows.map(r => r.length));
    const allItems = [];

    for (let base = 0; base + 1 < maxCols; base += 3) {
        const gCol = base, tCol = base+1, nCol = base+2;
        rows.forEach(row => {
            const group  = row[gCol]?.trim()  || "";
            const ticker = row[tCol]?.trim() || "";
            const name   = row[nCol]?.trim()   || "";
            if (group && ticker) allItems.push({group, ticker, name});
        });
    }

    const seen = new Set();
    const unique = allItems.filter(item => {
        if (seen.has(item.ticker)) return false;
        seen.add(item.ticker);
        return true;
    });

    unique.forEach((item, idx) => {
        const pageIdx = Math.floor(idx / (35 * NUM_COLS));
        const pos = idx % (35 * NUM_COLS);
        const colIdx = pos % NUM_COLS;
        tickerMeta[item.ticker] = { group:item.group, name:item.name, pageIdx, colIdx, order:idx };
        masterList.push(item.ticker);
    });

    numPages = Math.max(1, Math.ceil(unique.length / (35 * NUM_COLS)));
}

function buildChrome() {
    const tabsEl = document.getElementById("tabs");
    const pagesEl = document.getElementById("pages");
    tabsEl.innerHTML = "";
    pagesEl.innerHTML = "";

    for (let i = 0; i < numPages; i++) {
        const tab = document.createElement("button");
        tab.className = "tab" + (i===0 ? " active" : "");
        tab.textContent = `PAGE ${i+1}`;
        tab.onclick = () => switchPage(i);
        tabsEl.appendChild(tab);

        const page = document.createElement("div");
        page.className = "page" + (i===0 ? " active" : "");
        page.id = `page-${i}`;

        for (let c = 0; c < NUM_COLS; c++) {
            const col = document.createElement("div");
            col.className = "col";
            col.id = `col-${i}-${c}`;
            page.appendChild(col);
        }
        pagesEl.appendChild(page);
    }
}

function switchPage(idx) {
    document.querySelectorAll(".tab,.page").forEach((el,i) =>
        el.classList.toggle("active", i % numPages === idx % numPages));
}

document.addEventListener("keydown", e => {
    if (e.key === "ArrowRight" || e.key === "ArrowLeft") {
        let cur = [...document.querySelectorAll(".tab")].findIndex(t => t.classList.contains("active"));
        cur = e.key === "ArrowRight" ? cur + 1 : cur - 1;
        switchPage((cur + numPages) % numPages);
    }
});

document.addEventListener("dblclick", e => {
    const cell = e.target.closest(".cell-ticker");
    if (cell) window.open(`https://finance.yahoo.com/quote/${cell.textContent.trim()}/`, "_blank");
});

function insertByOrder(container, el, order) {
    el.dataset.order = order;
    const kids = [...container.children];
    const after = kids.find(c => (parseFloat(c.dataset.order) || 999) > order);
    if (after) container.insertBefore(el, after);
    else container.appendChild(el);
}

function renderTicker(ticker) {
    const q = quoteStore[ticker];
    const meta = tickerMeta[ticker];
    if (!q || !meta) return;

    const col = document.getElementById(`col-${meta.pageIdx}-${meta.colIdx}`);
    if (!col) return;

    const gid = `grp-${meta.pageIdx}-${meta.colIdx}-${meta.group.replace(/\W+/g,"-")}`;
    if (!document.getElementById(gid)) {
        const g = document.createElement("div");
        g.className = "group";
        g.id = gid;
        g.textContent = meta.group;
        insertByOrder(col, g, meta.order - 0.5);
    }

    const up = q.d >= 0;
    const color = up ? "green" : "red";
    const sign = up ? "+" : "";

    let row = col.querySelector(`[data-ticker="${ticker}"]`);
    if (!row) {
        row = document.createElement("div");
        row.dataset.ticker = ticker;
        insertByOrder(col, row, meta.order);
    }

    row.className = `row ${color}`;
    row.innerHTML = `
        <div class="cell-ticker">${ticker}</div>
        <div class="cell-name" title="${meta.name}">${meta.name}</div>
        <div class="cell-price">${q.c.toFixed(2)}</div>
        <div class="cell-chg">${sign}${q.d.toFixed(2)}</div>
        <div class="cell-pct">${sign}${q.dp.toFixed(2)}%</div>
        <div class="cell-age">${ageLabel(q.updatedAt)}</div>
    `;
}

setInterval(() => {
    masterList.forEach(t => {
        const meta = tickerMeta[t];
        const q = quoteStore[t];
        if (!meta || !q) return;
        const ageEl = document.querySelector(`#col-${meta.pageIdx}-${meta.colIdx} [data-ticker="${t}"] .cell-age`);
        if (ageEl) ageEl.textContent = ageLabel(q.updatedAt);
    });
}, 30000);

async function fetchQuote(ticker) {
    const url = `https://finnhub.io/api/v1/quote?symbol=${encodeURIComponent(ticker)}&token=${API_KEY}`;
    for (let i = 0; i < 5; i++) {
        try {
            const res = await fetch(url);
            if (res.status === 429) {
                setStatus("Rate limited — pausing 65s…", true);
                await sleep(PAUSE_ON_429);
                continue;
            }
            if (!res.ok) return;
            const data = await res.json();
            if (data?.c != null && data.c !== 0) {
                quoteStore[ticker] = { c:data.c, d:data.d, dp:data.dp, updatedAt:Date.now() };
                renderTicker(ticker);
            }
            return;
        } catch {
            await sleep(2000);
        }
    }
}

async function rollingLoop() {
    let idx = 0;
    while (true) {
        const t = masterList[idx];
        setStatus(`Fetching ${t}…`);
        setCounter(idx+1, masterList.length);
        await fetchQuote(t);
        await sleep(CALL_DELAY_MS);
        idx = (idx + 1) % masterList.length;
    }
}

async function init() {
    setStatus("Reading sheet…");
    await buildMasterList();
    buildChrome();
    rollingLoop();
}

init();
</script>
</body>
</html>
