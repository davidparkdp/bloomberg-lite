<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Bloomberg Lite</title>
<style>
* { box-sizing: border-box; }
body {
    margin: 0;
    background: #0a0a0a;
    color: #00ffcc;
    font-family: monospace;
    font-size: 12px;
}
.header {
    display: flex;
    align-items: center;
    color: orange;
    padding: 6px 12px;
    border-bottom: 1px solid #333;
    background: #111;
}
.header-title { font-size: 14px; font-weight: bold; letter-spacing: 2px; }
.header-time  { color: #888; font-size: 11px; margin-left: auto; }

.tabs {
    display: flex;
    gap: 2px;
    padding: 4px 12px;
    background: #111;
    border-bottom: 1px solid #333;
}
.tab {
    padding: 3px 14px;
    cursor: pointer;
    border: 1px solid #444;
    color: #888;
    background: transparent;
    font-family: monospace;
    font-size: 11px;
    letter-spacing: 1px;
    transition: all .15s;
}
.tab.active { border-color: orange; color: orange; background: rgba(255,165,0,.08); }
.tab:hover:not(.active) { color: #ccc; border-color: #666; }

.page { display: none; padding: 8px 10px; }
.page.active { display: flex; align-items: flex-start; gap: 0; }

.panel {
    flex: 1;
    min-width: 0;
    padding: 0 10px;
    border-right: 1px solid #222;
}
.panel:first-child { padding-left: 0; }
.panel:last-child  { border-right: none; }

.group {
    color: orange;
    margin-top: 14px;
    margin-bottom: 1px;
    font-size: 10px;
    letter-spacing: 1px;
    border-bottom: 1px solid #222;
    padding-bottom: 2px;
}
.group:first-child { margin-top: 2px; }

/* 
  Columns: ticker | name | price | chg | pct | age
  Kept tight — name is the flex column but capped small
*/
.row {
    display: grid;
    grid-template-columns: 52px 90px 68px 62px 60px 28px;
    padding: 2px 0;
    border-bottom: 1px solid #0f0f0f;
    align-items: center;
}
.row:hover { background: #141414; }

.cell-ticker {
    text-align: left;
    font-weight: bold;
    font-size: 12px;
}
.cell-name {
    text-align: left;
    font-size: 10px;
    padding-right: 4px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    cursor: default;
    opacity: 0.85;
}
.cell-price { text-align: right; font-size: 12px; }
.cell-chg   { text-align: right; font-size: 12px; }
.cell-pct   { text-align: right; font-size: 12px; }

/* Age indicator — small dot that fades from bright to dim as data gets stale */
.cell-age {
    text-align: right;
    font-size: 9px;
    opacity: 0.4;
    padding-left: 2px;
}

.green { color: #00e676; }
.red   { color: #ff5252; }

.spinner { color: #444; padding: 40px 20px; letter-spacing: 2px; font-size: 11px; }

.statusbar {
    position: fixed;
    bottom: 0; left: 0; right: 0;
    background: #111;
    border-top: 1px solid #222;
    padding: 2px 12px;
    font-size: 10px;
    color: #555;
    display: flex;
    gap: 20px;
}
.statusbar span { color: #666; }
.status-warn { color: #ffaa00 !important; }
</style>
</head>
<body>

<div class="header">
    <div class="header-title">◆ BLOOMBERG LITE</div>
    <div class="header-time" id="clock"></div>
</div>
<div class="tabs" id="tabs"></div>
<div id="pages"></div>
<div class="statusbar">
    <span id="status">Loading…</span>
    <span id="counter"></span>
</div>

<script>
// ─────────────────────────────────────────────────────────
// CONFIG
// ─────────────────────────────────────────────────────────
const API_KEY       = "d6atqi1r01qnr27isiq0d6atqi1r01qnr27isiqg";
const CALL_DELAY_MS = 1200;   // 1.2s per call = 50/min, under the 60/min limit
const PAUSE_ON_429  = 65000;  // pause 65s on rate limit then retry

const SHEETS = [
    { label: "PAGE 1", url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vT46q9pwRZMT27tLH6taYNgIYXFPkLdnjOhv3KqqGJGJY_Dn1SJ6yI4v1jaODaHy33TwbM-L5z14UWF/pub?gid=0&single=true&output=csv" },
    { label: "PAGE 2", url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vT46q9pwRZMT27tLH6taYNgIYXFPkLdnjOhv3KqqGJGJY_Dn1SJ6yI4v1jaODaHy33TwbM-L5z14UWF/pub?gid=1898380729&single=true&output=csv" },
    { label: "PAGE 3", url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vT46q9pwRZMT27tLH6taYNgIYXFPkLdnjOhv3KqqGJGJY_Dn1SJ6yI4v1jaODaHy33TwbM-L5z14UWF/pub?gid=710341566&single=true&output=csv" },
];

// Col layout per panel:  group | ticker | name
const PANELS = [
    { groupCol: 0, tickerCol: 1, nameCol: 2 },
    { groupCol: 3, tickerCol: 4, nameCol: 5 },
    { groupCol: 6, tickerCol: 7, nameCol: 8 },
];

// ─────────────────────────────────────────────────────────
// STATE
// quoteStore[ticker] = { c, d, dp, updatedAt }
// tickerMeta[ticker] = { group, name, pageIdx, panelIdx }
// ─────────────────────────────────────────────────────────
const quoteStore = {};  // live price data keyed by ticker
const tickerMeta = {};  // static info keyed by ticker
let   masterList = [];  // ordered list of all tickers across all pages/panels

// ─────────────────────────────────────────────────────────
// UTILITIES
// ─────────────────────────────────────────────────────────
const sleep = ms => new Promise(r => setTimeout(r, ms));

function setStatus(msg, warn = false) {
    const el = document.getElementById("status");
    el.textContent = msg;
    el.className = warn ? "status-warn" : "";
}

function setCounter(current, total) {
    document.getElementById("counter").textContent = `${current} / ${total}`;
}

function updateClock() {
    const now = new Date();
    document.getElementById("clock").textContent =
        now.toLocaleDateString("en-US", { weekday:"short", month:"short", day:"numeric" })
        + "  " + now.toLocaleTimeString("en-US", { hour12: false });
}
setInterval(updateClock, 1000);
updateClock();

// Format age as e.g. "2m" or "45s"
function ageLabel(updatedAt) {
    if (!updatedAt) return "";
    const s = Math.floor((Date.now() - updatedAt) / 1000);
    if (s < 60)  return `${s}s`;
    if (s < 3600) return `${Math.floor(s/60)}m`;
    return `${Math.floor(s/3600)}h`;
}

// ─────────────────────────────────────────────────────────
// CSV LOADER
// ─────────────────────────────────────────────────────────
async function loadCSV(url) {
    const res  = await fetch(url);
    const text = await res.text();
    return text.trim().split("\n").map(r => r.split(",").map(c => c.trim()));
}

// ─────────────────────────────────────────────────────────
// BUILD MASTER LIST from all sheets
// Called once at startup. Populates tickerMeta and masterList.
// ─────────────────────────────────────────────────────────
async function buildMasterList() {
    masterList = [];
    for (let si = 0; si < SHEETS.length; si++) {
        const rows = await loadCSV(SHEETS[si].url);
        PANELS.forEach((p, pi) => {
            rows.forEach(row => {
                const group  = row[p.groupCol]  || "";
                const ticker = row[p.tickerCol] || "";
                const name   = row[p.nameCol]   || "";
                if (!group || !ticker) return;
                if (tickerMeta[ticker]) return; // already seen (dedup)
                tickerMeta[ticker] = { group, name, pageIdx: si, panelIdx: pi };
                masterList.push(ticker);
            });
        });
    }
}

// ─────────────────────────────────────────────────────────
// UI CHROME
// ─────────────────────────────────────────────────────────
function buildChrome() {
    const tabsEl  = document.getElementById("tabs");
    const pagesEl = document.getElementById("pages");
    SHEETS.forEach((sheet, i) => {
        const tab = document.createElement("button");
        tab.className = "tab" + (i === 0 ? " active" : "");
        tab.textContent = sheet.label;
        tab.onclick = () => switchPage(i);
        tabsEl.appendChild(tab);

        const page = document.createElement("div");
        page.className = "page" + (i === 0 ? " active" : "");
        page.id = `page-${i}`;
        // Pre-build panel skeletons — rows will be added as data arrives
        let html = "";
        PANELS.forEach((_, pi) => {
            html += `<div class="panel" id="panel-${i}-${pi}"></div>`;
        });
        page.innerHTML = html;
        pagesEl.appendChild(page);
    });
}

function switchPage(idx) {
    document.querySelectorAll(".tab").forEach((t,i) => t.classList.toggle("active", i===idx));
    document.querySelectorAll(".page").forEach((p,i) => p.classList.toggle("active", i===idx));
}

// Keyboard navigation
document.addEventListener("keydown", e => {
    if (e.key === "ArrowRight" || e.key === "ArrowLeft") {
        const tabs = document.querySelectorAll(".tab");
        let cur = [...tabs].findIndex(t => t.classList.contains("active"));
        if (e.key === "ArrowRight") cur = (cur + 1) % SHEETS.length;
        if (e.key === "ArrowLeft")  cur = (cur - 1 + SHEETS.length) % SHEETS.length;
        switchPage(cur);
    }
});

// ─────────────────────────────────────────────────────────
// RENDER — update a single ticker's row in the DOM
// Creates the row if it doesn't exist yet.
// ─────────────────────────────────────────────────────────
function renderTicker(ticker) {
    const q    = quoteStore[ticker];
    const meta = tickerMeta[ticker];
    if (!q || !meta) return;

    const panelEl = document.getElementById(`panel-${meta.pageIdx}-${meta.panelIdx}`);
    if (!panelEl) return;

    // Ensure group header exists
    let groupEl = panelEl.querySelector(`[data-group="${meta.group}"]`);
    if (!groupEl) {
        groupEl = document.createElement("div");
        groupEl.className = "group";
        groupEl.dataset.group = meta.group;
        groupEl.textContent = meta.group;
        panelEl.appendChild(groupEl);
    }

    const up    = q.d >= 0;
    const color = up ? "green" : "red";
    const sign  = up ? "+" : "";
    const age   = ageLabel(q.updatedAt);

    let rowEl = panelEl.querySelector(`[data-ticker="${ticker}"]`);
    if (!rowEl) {
        rowEl = document.createElement("div");
        rowEl.dataset.ticker = ticker;
        // Insert after the group header and any existing rows for this group
        groupEl.insertAdjacentElement("afterend", rowEl);
        // Re-sort: move this row after the last sibling with same group
        // (simple approach: just append after groupEl if row is new)
    }

    rowEl.className = `row ${color}`;
    rowEl.innerHTML = `
        <div class="cell-ticker">${ticker}</div>
        <div class="cell-name" title="${meta.name}">${meta.name}</div>
        <div class="cell-price">${q.c.toFixed(2)}</div>
        <div class="cell-chg">${sign}${q.d.toFixed(2)}</div>
        <div class="cell-pct">${sign}${q.dp.toFixed(2)}%</div>
        <div class="cell-age">${age}</div>
    `;
}

// Update just the age labels every 30s without re-fetching
setInterval(() => {
    masterList.forEach(ticker => {
        const q    = quoteStore[ticker];
        const meta = tickerMeta[ticker];
        if (!q || !meta) return;
        const panelEl = document.getElementById(`panel-${meta.pageIdx}-${meta.panelIdx}`);
        if (!panelEl) return;
        const rowEl = panelEl.querySelector(`[data-ticker="${ticker}"]`);
        if (!rowEl) return;
        const ageEl = rowEl.querySelector(".cell-age");
        if (ageEl) ageEl.textContent = ageLabel(q.updatedAt);
    });
}, 30000);

// ─────────────────────────────────────────────────────────
// CONTINUOUS ROLLING FETCH LOOP
// Goes through masterList one ticker at a time, forever.
// Never re-fetches a ticker until all others have been done.
// ─────────────────────────────────────────────────────────
async function fetchQuote(ticker) {
    const url = `https://finnhub.io/api/v1/quote?symbol=${encodeURIComponent(ticker)}&token=${API_KEY}`;
    for (let attempt = 0; attempt < 5; attempt++) {
        try {
            const res = await fetch(url);
            if (res.status === 429) {
                setStatus(`Rate limited — pausing 65s…`, true);
                await sleep(PAUSE_ON_429);
                continue;
            }
            if (!res.ok) return;
            const data = await res.json();
            if (data && data.c != null && data.c !== 0) {
                quoteStore[ticker] = { c: data.c, d: data.d, dp: data.dp, updatedAt: Date.now() };
                renderTicker(ticker);
            }
            return; // success
        } catch {
            await sleep(2000);
        }
    }
}

async function rollingLoop() {
    let idx = 0;
    while (true) {
        const ticker = masterList[idx];
        setStatus(`Fetching ${ticker}…`);
        setCounter(idx + 1, masterList.length);
        await fetchQuote(ticker);
        await sleep(CALL_DELAY_MS);
        idx = (idx + 1) % masterList.length;
    }
}

// ─────────────────────────────────────────────────────────
// INIT
// ─────────────────────────────────────────────────────────
async function init() {
    buildChrome();
    setStatus("Reading sheets…");
    await buildMasterList();
    setStatus("Starting…");
    rollingLoop(); // fire and forget — runs forever
}

init();
</script>
</body>
</html>
