<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Bloomberg Lite</title>
    <link rel="icon" href="data:,">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { height: 100%; }
        body {
            height: 100%;
            display: flex;
            flex-direction: column;
            background: #0a0a0a;
            color: #00ffcc;
            font-family: monospace;
            font-size: 13px;
            overflow: hidden;
        }
        .header {
            flex-shrink: 0;
            display: flex;
            align-items: center;
            color: orange;
            padding: 6px 12px;
            border-bottom: 1px solid #333;
            background: #111;
        }
        .header-title { font-size: 14px; font-weight: bold; letter-spacing: 2px; }
        .header-time  { color: #888; font-size: 11px; margin-left: auto; }
        .tabs {
            flex-shrink: 0;
            display: flex;
            gap: 2px;
            padding: 4px 12px;
            background: #111;
            border-bottom: 1px solid #333;
        }
        .tab {
            padding: 3px 14px;
            cursor: pointer;
            border: 1px solid #444;
            color: #888;
            background: transparent;
            font-family: monospace;
            font-size: 11px;
            letter-spacing: 1px;
            transition: all .15s;
        }
        .tab.active { border-color: orange; color: orange; background: rgba(255,165,0,.08); }
        .tab:hover:not(.active) { color: #ccc; border-color: #666; }
        
        #pages {
            flex: 1;
            position: relative;
            background: #0a0a0a;
        }
        .page {
            display: none;
            position: absolute;
            inset: 0;
            padding: 0 6px;
        }
        .page.active { display: flex; }
        .col {
            flex: 1;
            border-right: 1px solid #1a1a1a;
            height: 100%;
        }
        .col:last-child { border-right: none; }

        /* Each 'slot' in our grid is exactly 21px high */
        .group {
            color: orange;
            height: 42px; /* Exactly 2 rows high */
            display: flex;
            align-items: flex-end;
            padding-bottom: 4px;
            padding-left: 3px;
            font-size: 11px;
            font-weight: bold;
            letter-spacing: 1px;
            border-bottom: 1px solid #1e1e1e;
            text-transform: uppercase;
        }
        
        .row {
            display: grid;
            grid-template-columns: 48px 82px 66px 58px 56px 20px;
            height: 21px; /* Exactly 1 row high */
            line-height: 21px;
            padding: 0 3px;
            border-bottom: 1px solid #0f0f0f;
            align-items: center;
            gap: 1px;
        }
        .row:hover { background: #141414; }
        .cell-ticker { font-weight: bold; color: #ffb300; cursor: pointer; }
        .cell-name {
            color: #ffb300; font-size: 11px;
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
            opacity: 0.85;
        }
        .cell-price, .cell-chg, .cell-pct, .cell-age { text-align: right; }
        .cell-age { font-size: 9px; color: #ffb300 !important; opacity: 0.6; }
        .green { color: #00e676; }
        .red   { color: #ff5252; }

        .statusbar {
            flex-shrink: 0;
            background: #111;
            border-top: 1px solid #222;
            padding: 2px 12px;
            font-size: 10px;
            color: #555;
            display: flex;
            gap: 16px;
        }
        .status-warn { color: #ffaa00 !important; }
    </style>
</head>
<body>
<div class="header">
    <div class="header-title">◆ BLOOMBERG LITE</div>
    <div class="header-time" id="clock"></div>
</div>
<div class="tabs" id="tabs"></div>
<div id="pages"></div>
<div class="statusbar">
    <span id="status">Loading…</span>
    <span id="counter"></span>
</div>

<script>
const API_KEY       = "d6atqi1r01qnr27isiq0d6atqi1r01qnr27isiqg";
const CALL_DELAY_MS = 1200;
const PAUSE_ON_429  = 3000; 
const NUM_COLS      = 5;
const SHEET_URL     = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT46q9pwRZMT27tLH6taYNgIYXFPkLdnjOhv3KqqGJGJY_Dn1SJ6yI4v1jaODaHy33TwbM-L5z14UWF/pub?gid=0&single=true&output=csv";

function parseCSV(text) {
    return text.trim().split("\n").map(line => {
        const fields = [];
        let cur = "", inQ = false;
        for (const ch of line) {
            if (ch === '"') inQ = !inQ;
            else if (ch === ',' && !inQ) { fields.push(cur.trim()); cur = ""; }
            else cur += ch;
        }
        fields.push(cur.trim());
        return fields;
    });
}

const quoteStore = {};
const tickerMeta = {};
let masterList = [];
let numPages = 0;

function updateClock() {
    const now = new Date();
    document.getElementById("clock").textContent =
        now.toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric"})
        + "  " + now.toLocaleTimeString("en-US",{hour12:false});
}
setInterval(updateClock, 1000);
updateClock();

async function buildMasterList() {
    const r = await fetch(SHEET_URL);
    const rows = parseCSV(await r.text());
    const maxCols = Math.max(...rows.map(r => r.length));

    const allItems = [];
    for (let base = 0; base + 1 < maxCols; base += 3) {
        rows.forEach(row => {
            const group  = row[base] || "";
            const ticker = row[base + 1] || "";
            const name   = row[base + 2] || "";
            if (group && ticker) allItems.push({ group, ticker, name });
        });
    }

    const seen = new Set();
    const unique = allItems.filter(item => {
        if (seen.has(item.ticker)) return false;
        seen.add(item.ticker);
        return true;
    });

    const pagesEl = document.getElementById("pages");
    const colH = pagesEl.offsetHeight;
    const rowH = 21; 
    
    // Total vertical "units" available in a column
    const totalUnits = Math.floor(colH / rowH);
    
    let currentPage = 0;
    let currentCol = 0;
    let currentUnitsUsed = 0;
    let lastGroup = "";

    unique.forEach((item) => {
        // A new group needs 2 units (header) + 1 unit (the row itself)
        // An existing group just needs 1 unit (the row)
        const unitsNeeded = (item.group !== lastGroup) ? 3 : 1;

        if (currentUnitsUsed + unitsNeeded > totalUnits) {
            currentCol++;
            currentUnitsUsed = 0;
            if (currentCol >= NUM_COLS) {
                currentPage++;
                currentCol = 0;
            }
            // If we move to a new column, the header is required again
            currentUnitsUsed += 3; 
        } else {
            currentUnitsUsed += unitsNeeded;
        }

        tickerMeta[item.ticker] = {
            group: item.group,
            name: item.name,
            pageIdx: currentPage,
            colIdx: currentCol,
            isFirstInCol: (currentUnitsUsed === 3) || (item.group !== lastGroup)
        };
        masterList.push(item.ticker);
        lastGroup = item.group;
    });

    numPages = currentPage + 1;
}

function buildChrome() {
    const tabsEl = document.getElementById("tabs");
    const pagesEl = document.getElementById("pages");
    tabsEl.innerHTML = ""; pagesEl.innerHTML = "";

    for (let i = 0; i < numPages; i++) {
        const tab = document.createElement("button");
        tab.className = "tab" + (i===0?" active":"");
        tab.textContent = `PAGE ${i+1}`;
        tab.onclick = () => switchPage(i);
        tabsEl.appendChild(tab);

        const page = document.createElement("div");
        page.className = "page" + (i===0?" active":"");
        page.id = `page-${i}`;
        for (let c = 0; c < NUM_COLS; c++) {
            const col = document.createElement("div");
            col.className = "col";
            col.id = `col-${i}-${c}`;
            page.appendChild(col);
        }
        pagesEl.appendChild(page);
    }
}

function renderAllPlaceholders() {
    masterList.forEach(ticker => {
        const meta = tickerMeta[ticker];
        const colEl = document.getElementById(`col-${meta.pageIdx}-${meta.colIdx}`);
        
        if (meta.isFirstInCol) {
            const g = document.createElement("div");
            g.className = "group";
            g.textContent = meta.group;
            colEl.appendChild(g);
        }

        const rowEl = document.createElement("div");
        rowEl.dataset.ticker = ticker;
        rowEl.className = "row";
        rowEl.innerHTML = `
            <div class="cell-ticker">${ticker}</div>
            <div class="cell-name">${meta.name}</div>
            <div class="cell-price">...</div>
            <div class="cell-chg">...</div>
            <div class="cell-pct">...</div>
            <div class="cell-age"></div>
        `;
        colEl.appendChild(rowEl);
    });
}

function switchPage(idx) {
    document.querySelectorAll(".tab").forEach((t,i) => t.classList.toggle("active", i===idx));
    document.querySelectorAll(".page").forEach((p,i) => p.classList.toggle("active", i===idx));
}

function renderTicker(ticker) {
    const q = quoteStore[ticker], meta = tickerMeta[ticker];
    const rowEl = document.querySelector(`[data-ticker="${ticker}"]`);
    if (!q || !rowEl) return;

    const up = q.d >= 0, color = up ? "green" : "red", sign = up ? "+" : "";
    rowEl.className = `row ${color}`;
    rowEl.innerHTML = `
        <div class="cell-ticker">${ticker}</div>
        <div class="cell-name">${meta.name}</div>
        <div class="cell-price">${q.c.toFixed(2)}</div>
        <div class="cell-chg">${sign}${q.d.toFixed(2)}</div>
        <div class="cell-pct">${sign}${q.dp.toFixed(2)}%</div>
        <div class="cell-age">${Math.floor((Date.now()-q.ts)/1000)}s</div>
    `;
}

async function rollingLoop() {
    let idx = 0;
    while (true) {
        const t = masterList[idx];
        document.getElementById("status").textContent = `Fetching ${t}...`;
        document.getElementById("counter").textContent = `${idx+1}/${masterList.length}`;
        
        try {
            const res = await fetch(`https://finnhub.io/api/v1/quote?symbol=${t}&token=${API_KEY}`);
            if (res.status === 429) { await new Promise(r => setTimeout(r, PAUSE_ON_429)); continue; }
            const data = await res.json();
            if (data.c) {
                quoteStore[t] = { c:data.c, d:data.d, dp:data.dp, ts:Date.now() };
                renderTicker(t);
            }
        } catch (e) {}
        
        await new Promise(r => setTimeout(r, CALL_DELAY_MS));
        idx = (idx + 1) % masterList.length;
    }
}

async function init() {
    await buildMasterList();
    buildChrome();
    renderAllPlaceholders();
    rollingLoop();
}

init();
</script>
</body>
</html>
