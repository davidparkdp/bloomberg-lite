<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Bloomberg Lite</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; background: #0a0a0a; color: #00ffcc; font-family: monospace; font-size: 13px; overflow: hidden; }
        .header { flex-shrink: 0; display: flex; align-items: center; color: orange; padding: 6px 12px; border-bottom: 1px solid #333; background: #111; }
        .header-title { font-size: 14px; font-weight: bold; letter-spacing: 2px; }
        .header-time  { color: #888; font-size: 11px; margin-left: auto; }
        .tabs { flex-shrink: 0; display: flex; gap: 2px; padding: 4px 12px; background: #111; border-bottom: 1px solid #333; overflow-x: auto; white-space: nowrap; }
        .tab { flex-shrink: 0; padding: 3px 14px; cursor: pointer; border: 1px solid #444; color: #888; background: transparent; font-family: monospace; font-size: 11px; }
        .tab.active { border-color: orange; color: orange; background: rgba(255,165,0,.08); }
        
        #pages { flex: 1; position: relative; height: 100%; }
        .page { display: none; position: absolute; inset: 0; padding: 0 6px; flex-direction: row; }
        .page.active { display: flex; }
        .col { flex: 1; border-right: 1px solid #1a1a1a; height: 100%; overflow: hidden; display: flex; flex-direction: column; }
        .col:last-child { border-right: none; }
        
        /* Fixed Header Logic */
        .group { color: orange; height: 36px; display: flex; align-items: flex-end; padding: 0 0 4px 3px; font-size: 11px; font-weight: bold; text-transform: uppercase; border-bottom: 1px solid #1e1e1e; white-space: nowrap; overflow: hidden; flex-shrink: 0; }
        
        /* WIDER NAME COLUMN: Reset to 100px for better legibility */
        .row { display: grid; grid-template-columns: 50px 100px 60px 52px 52px 25px; height: 21px; line-height: 21px; padding: 0 3px; border-bottom: 1px solid #0f0f0f; align-items: center; gap: 4px; flex-shrink: 0; }
        .row:hover { background: #141414; }
        
        .cell-ticker a { font-weight: bold; color: #ffb300; text-decoration: none; }
        .cell-name { color: #ffb300; font-size: 10px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; opacity: 0.85; }
        .cell-price, .cell-chg, .cell-pct, .cell-age { text-align: right; font-size: 11px; }
        .cell-age { font-size: 9px; color: #ffb300; opacity: 0.5; }
        .green { color: #00e676; }
        .red { color: #ff5252; }
        .statusbar { flex-shrink: 0; background: #111; border-top: 1px solid #222; padding: 2px 12px; font-size: 10px; color: #555; display: flex; gap: 16px; height: 22px; align-items: center; }
    </style>
</head>
<body style="display: flex; flex-direction: column;">

<div class="header">
    <div class="header-title">â—† BLOOMBERG LITE</div>
    <div class="header-time" id="clock"></div>
</div>
<div class="tabs" id="tabs"></div>
<div id="pages"></div>
<div class="statusbar">
    <span id="status">CONNECTING...</span>
    <span id="counter"></span>
</div>

<script>
const API_KEY = "d6atqi1r01qnr27isiq0d6atqi1r01qnr27isiqg";
const CALL_DELAY = 1200;
const NUM_COLS = 5;
const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT46q9pwRZMT27tLH6taYNgIYXFPkLdnjOhv3KqqGJGJY_Dn1SJ6yI4v1jaODaHy33TwbM-L5z14UWF/pub?gid=0&single=true&output=csv";

let masterList = [];
let quoteStore = {};
let numPages = 0;

function parseCSVLine(line) {
    const result = [];
    let cur = "", inQuotes = false;
    for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (char === '"') inQuotes = !inQuotes;
        else if (char === ',' && !inQuotes) { result.push(cur.trim()); cur = ""; }
        else cur += char;
    }
    result.push(cur.trim());
    return result;
}

function updateClock() {
    const now = new Date();
    document.getElementById("clock").textContent = now.toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric"}) + "  " + now.toLocaleTimeString("en-US",{hour12:false});
}
setInterval(updateClock, 1000);

async function init() {
    try {
        const resp = await fetch(SHEET_URL);
        const text = await resp.text();
        const lines = text.trim().split(/\r?\n/);
        const rows = lines.map(line => parseCSVLine(line));
        
        const rawData = [];
        const maxColsAvailable = Math.max(...rows.map(r => r.length));
        
        // Step 1: Flatten all CSV data into a continuous list of items
        for (let b = 0; b < maxColsAvailable; b += 3) {
            let currentBucket = "";
            rows.forEach(row => {
                const colA = (row[b] || "");
                const colB = (row[b+1] || "");
                const colC = (row[b+2] || "");
                if (colA && !colB) currentBucket = colA; 
                else if (colB && colB.toLowerCase() !== "ticker" && colB.length < 12 && !colB.includes(" ")) {
                    if (colA) currentBucket = colA;
                    rawData.push({ group: currentBucket || "VARIOUS", ticker: colB.toUpperCase(), name: colC });
                }
            });
        }

        // Step 2: Build UI with repeated headers
        const pEl = document.getElementById("pages");
        const availH = pEl.offsetHeight || 800;
        const ROW_H = 21;
        const HDR_H = 36;
        
        let curP = 0, curC = 0, usedH = 0, lastG = "";
        let pageData = [[[]]]; // Structure: [Page][Column][Items]

        rawData.forEach(item => {
            const isNewG = item.group !== lastG;
            let needed = ROW_H;
            if (isNewG || usedH === 0) needed += HDR_H;

            // If it doesn't fit, move to next column
            if (usedH + needed > availH) {
                curC++;
                if (curC >= NUM_COLS) { curP++; curC = 0; }
                usedH = 0;
                if (!pageData[curP]) pageData[curP] = [];
                if (!pageData[curP][curC]) pageData[curP][curC] = [];
                
                // Force header because it's the start of a column
                pageData[curP][curC].push({ type: 'HDR', val: item.group });
                usedH += HDR_H;
            } else if (isNewG) {
                pageData[curP][curC].push({ type: 'HDR', val: item.group });
                usedH += HDR_H;
            }

            pageData[curP][curC].push({ type: 'ROW', ...item });
            usedH += ROW_H;
            lastG = item.group;
            if (!masterList.includes(item.ticker)) masterList.push(item.ticker);
        });

        numPages = pageData.length;
        renderUI(pageData);
        rollingLoop();
    } catch (err) { console.error(err); }
}

function renderUI(pageData) {
    const tEl = document.getElementById("tabs"), pEl = document.getElementById("pages");
    tEl.innerHTML = ""; pEl.innerHTML = "";
    
    pageData.forEach((page, pIdx) => {
        const btn = document.createElement("button");
        btn.className = "tab" + (pIdx===0?" active":"");
        btn.textContent = `PAGE ${pIdx+1}`;
        btn.onclick = () => {
            document.querySelectorAll(".tab, .page").forEach(el => el.classList.remove("active"));
            btn.classList.add("active");
            document.getElementById(`page-${pIdx}`).classList.add("active");
        };
        tEl.appendChild(btn);

        const pg = document.createElement("div");
        pg.className = "page" + (pIdx===0?" active":"");
        pg.id = `page-${pIdx}`;
        
        for (let cIdx = 0; cIdx < NUM_COLS; cIdx++) {
            const col = document.createElement("div");
            col.className = "col";
            const items = page[cIdx] || [];
            items.forEach(item => {
                if (item.type === 'HDR') {
                    const h = document.createElement("div");
                    h.className = "group"; h.textContent = item.val;
                    col.appendChild(h);
                } else {
                    const r = document.createElement("div");
                    const safeId = item.ticker.replace(/[^a-zA-Z0-9]/g, '-');
                    r.className = "row"; r.id = `row-${safeId}`;
                    r.innerHTML = `
                        <div class="cell-ticker"><a href="https://finance.yahoo.com/quote/${item.ticker}" target="_blank">${item.ticker}</a></div>
                        <div class="cell-name">${item.name}</div>
                        <div class="cell-price">...</div>
                        <div class="cell-chg">...</div>
                        <div class="cell-pct">...</div>
                        <div class="cell-age" id="age-${safeId}"></div>`;
                    col.appendChild(r);
                }
            });
            pg.appendChild(col);
        }
        pEl.appendChild(pg);
    });
}

async function rollingLoop() {
    let i = 0;
    while(true) {
        const t = masterList[i];
        const safeId = t.replace(/[^a-zA-Z0-9]/g, '-');
        document.getElementById("status").textContent = `FETCH: ${t}`;
        document.getElementById("counter").textContent = `${i+1}/${masterList.length}`;
        try {
            const r = await fetch(`https://finnhub.io/api/v1/quote?symbol=${t}&token=${API_KEY}`);
            const d = await r.json();
            if (d.c && d.c !== 0) {
                const up = d.d >= 0;
                quoteStore[t] = { ts: Date.now() };
                const row = document.getElementById(`row-${safeId}`);
                if (row) {
                    row.className = `row ${up?'green':'red'}`;
                    row.querySelector(".cell-price").textContent = d.c.toFixed(2);
                    row.querySelector(".cell-chg").textContent = (up?'+':'')+d.d.toFixed(2);
                    row.querySelector(".cell-pct").textContent = (up?'+':'')+d.dp.toFixed(2)+'%';
                    row.querySelector(".cell-age").textContent = "0s";
                }
            }
        } catch(e) {}
        await new Promise(ok => setTimeout(ok, CALL_DELAY));
        i = (i + 1) % masterList.length;
    }
}

document.addEventListener("keydown", e => {
    const tabs = document.querySelectorAll(".tab");
    let cur = [...tabs].findIndex(t => t.classList.contains("active"));
    if (e.key === "ArrowRight") { cur = (cur + 1) % numPages; tabs[cur].click(); }
    if (e.key === "ArrowLeft") { cur = (cur - 1 + numPages) % numPages; tabs[cur].click(); }
});

init();
</script>
</body>
</html>
