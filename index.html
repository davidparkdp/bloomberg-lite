<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Bloomberg Lite</title>
<style>
/* ─────────────────────────────────────────────────────────
   CSS: FIXING GAPS AND COLUMNS
   ───────────────────────────────────────────────────────── */
* { box-sizing: border-box; }
body {
    margin: 0;
    background: #0a0a0a;
    color: #00ffcc;
    font-family: monospace;
    font-size: 13px;
    overflow-x: hidden; 
}
.header {
    display: flex;
    align-items: center;
    color: orange;
    padding: 8px 12px;
    border-bottom: 1px solid #333;
    background: #111;
}
.header-title { font-size: 15px; font-weight: bold; letter-spacing: 2px; }
.header-time  { color: #888; font-size: 12px; margin-left: auto; }

.tabs {
    display: flex;
    gap: 2px;
    padding: 6px 12px;
    background: #111;
    border-bottom: 1px solid #333;
}
.tab {
    padding: 4px 16px;
    cursor: pointer;
    border: 1px solid #444;
    color: #888;
    background: transparent;
    font-family: monospace;
    font-size: 12px;
    letter-spacing: 1px;
}
.tab.active { border-color: orange; color: orange; background: rgba(255,165,0,.08); }

.page { display: none; padding: 10px 12px; width: 100%; justify-content: space-between; }
.page.active { display: flex; }

.panel {
    flex: 1;
    min-width: 0; /* Allows panel to shrink to fit 3-col */
    padding: 0 8px;
    border-right: 1px solid #222;
}
.panel:last-child { border-right: none; }

.group {
    color: orange;
    margin-top: 10px;
    margin-bottom: 4px;
    font-size: 11px;
    letter-spacing: 1px;
    border-bottom: 1px solid #222;
    padding-bottom: 3px;
    text-transform: uppercase;
}

.row {
    display: grid;
    /* TICKER(50px) | NAME(100px) | PRICE | CHG | PCT */
    grid-template-columns: 50px 100px 1fr 1fr 1fr;
    gap: 5px;
    padding: 3px 0;
    border-bottom: 1px solid #111;
    align-items: center;
}
.row:hover { background: #141414; }

.cell-ticker { text-align: left; font-weight: bold; }
.cell-name {
    text-align: left;
    font-size: 11px;
    color: #00ffcc;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    opacity: 0.7;
}
.cell-price { text-align: right; color: #fff; font-weight: bold; }
.cell-chg   { text-align: right; }
.cell-pct   { text-align: right; }

.green { color: #00e676; }
.red   { color: #ff5252; }

@keyframes blink-flash {
    0%   { background: rgba(255,255,255,0.15); }
    100% { background: transparent; }
}
.blink { animation: blink-flash .5s ease-out; }

.statusbar {
    position: fixed;
    bottom: 0; left: 0; right: 0;
    background: #111;
    border-top: 1px solid #222;
    padding: 3px 12px;
    font-size: 11px;
    color: #555;
    display: flex;
    justify-content: space-between;
}
.status-warn { color: #ffaa00 !important; }
</style>
</head>
<body>

<div class="header">
    <div class="header-title">◆ BLOOMBERG LITE</div>
    <div class="header-time" id="clock"></div>
</div>
<div class="tabs" id="tabs"></div>
<div id="pages"></div>
<div class="statusbar">
    <span id="status">INITIALIZING...</span>
    <span id="last-update"></span>
</div>

<script>
// ─────────────────────────────────────────────────────────
// CONFIG: 1.5s DELAY TO PREVENT 429 ERRORS
// ─────────────────────────────────────────────────────────
const API_KEY       = "d6atqi1r01qnr27isiq0d6atqi1r01qnr27isiqg";
const CALL_DELAY_MS = 1500; 
const PAUSE_ON_429  = 65000;

const SHEETS = [
    { label: "PAGE 1", url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vT46q9pwRZMT27tLH6taYNgIYXFPkLdnjOhv3KqqGJGJY_Dn1SJ6yI4v1jaODaHy33TwbM-L5z14UWF/pub?gid=0&single=true&output=csv" },
    { label: "PAGE 2", url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vT46q9pwRZMT27tLH6taYNgIYXFPkLdnjOhv3KqqGJGJY_Dn1SJ6yI4v1jaODaHy33TwbM-L5z14UWF/pub?gid=1898380729&single=true&output=csv" },
    { label: "PAGE 3", url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vT46q9pwRZMT27tLH6taYNgIYXFPkLdnjOhv3KqqGJGJY_Dn1SJ6yI4v1jaODaHy33TwbM-L5z14UWF/pub?gid=710341566&single=true&output=csv" },
];

const PANELS = [
    { groupCol: 0, tickerCol: 1, nameCol: 2 },
    { groupCol: 3, tickerCol: 4, nameCol: 5 },
    { groupCol: 6, tickerCol: 7, nameCol: 8 },
];

let globalTickerList = []; 
let tickerPointer = 0;
const sleep = ms => new Promise(r => setTimeout(r, ms));

// ─────────────────────────────────────────────────────────
// API & DATA
// ─────────────────────────────────────────────────────────
async function apiFetch(url) {
    try {
        const res = await fetch(url);
        if (res.status === 429) {
            setStatus("RATE LIMIT HIT - PAUSING 65s", true);
            await sleep(PAUSE_ON_429);
            return null;
        }
        return res.ok ? await res.json() : null;
    } catch (e) { return null; }
}

async function getQuote(symbol) {
    setStatus(`FETCHING ${symbol}...`);
    return await apiFetch(`https://finnhub.io/api/v1/quote?symbol=${encodeURIComponent(symbol)}&token=${API_KEY}`);
}

async function loadCSV(url) {
    const res = await fetch(url);
    const text = await res.text();
    return text.trim().split("\n").map(r => r.split(",").map(c => c.trim()));
}

// ─────────────────────────────────────────────────────────
// UI BUILDERS
// ─────────────────────────────────────────────────────────
function setStatus(msg, warn = false) {
    const el = document.getElementById("status");
    el.textContent = msg;
    el.className = warn ? "status-warn" : "";
}

function updateClock() {
    const now = new Date();
    document.getElementById("clock").textContent =
        now.toLocaleDateString("en-US", { weekday:"short", month:"short", day:"numeric" })
        + "  " + now.toLocaleTimeString("en-US", { hour12: false });
}
setInterval(updateClock, 1000);

function buildChrome() {
    const tabsEl = document.getElementById("tabs");
    const pagesEl = document.getElementById("pages");
    SHEETS.forEach((sheet, i) => {
        const tab = document.createElement("button");
        tab.className = "tab" + (i === 0 ? " active" : "");
        tab.textContent = sheet.label;
        tab.onclick = () => switchPage(i);
        tabsEl.appendChild(tab);

        const page = document.createElement("div");
        page.className = "page" + (i === 0 ? " active" : "");
        page.id = `page-${i}`;
        pagesEl.appendChild(page);
    });
}

function switchPage(idx) {
    document.querySelectorAll(".tab").forEach((t,i) => t.classList.toggle("active", i===idx));
    document.querySelectorAll(".page").forEach((p,i) => p.classList.toggle("active", i===idx));
}

function buildInitialPanelDOM(rows, panel) {
    const { groupCol, tickerCol, nameCol } = panel;
    const items = rows.map(r => ({
        group: r[groupCol] || "",
        ticker: r[tickerCol] || "",
        name: r[nameCol] || ""
    })).filter(r => r.group && r.ticker);

    if (!items.length) return null;
    const panelEl = document.createElement("div");
    panelEl.className = "panel";
    let lastGroup = null;

    items.forEach(item => {
        if (item.group !== lastGroup) {
            lastGroup = item.group;
            const g = document.createElement("div"); g.className = "group"; g.textContent = item.group;
            panelEl.appendChild(g);
        }
        const row = document.createElement("div");
        const tickerClass = `tk-${item.ticker.replace(/[^a-z0-9]/gi, '_')}`;
        row.className = `row ${tickerClass}`;
        row.innerHTML = `
            <div class="cell-ticker">${item.ticker}</div>
            <div class="cell-name" title="${item.name}">${item.name}</div>
            <div class="cell-price">--</div>
            <div class="cell-chg">--</div>
            <div class="cell-pct">--</div>
        `;
        panelEl.appendChild(row);
    });
    return panelEl;
}

// ─────────────────────────────────────────────────────────
// SEQUENTIAL LOOP ENGINE
// ─────────────────────────────────────────────────────────
async function refreshStructure() {
    const allTickersSet = new Set();
    for (let i = 0; i < SHEETS.length; i++) {
        const rows = await loadCSV(SHEETS[i].url);
        const frag = document.createDocumentFragment();
        PANELS.forEach(p => {
            const node = buildInitialPanelDOM(rows, p);
            if (node) frag.appendChild(node);
        });
        document.getElementById(`page-${i}`).innerHTML = "";
        document.getElementById(`page-${i}`).appendChild(frag);
        
        rows.forEach(r => {
            PANELS.forEach(p => { if (r[p.tickerCol]) allTickersSet.add(r[p.tickerCol]); });
        });
    }
    globalTickerList = Array.from(allTickersSet);
}

function updateUIDisplay(symbol, q) {
    const color = q.d >= 0 ? "green" : "red";
    const sign = q.d >= 0 ? "+" : "";
    const tickerClass = `tk-${symbol.replace(/[^a-z0-9]/gi, '_')}`;
    
    document.querySelectorAll(`.${tickerClass}`).forEach(row => {
        row.className = `row ${color} ${tickerClass} blink`;
        row.querySelector('.cell-price').textContent = q.c.toFixed(2);
        row.querySelector('.cell-chg').textContent = `${sign}${q.d.toFixed(2)}`;
        row.querySelector('.cell-pct').textContent = `${sign}${q.dp.toFixed(2)}%`;
        setTimeout(() => row.classList.remove('blink'), 400);
    });
}

async function startLoop() {
    while (true) {
        if (globalTickerList.length > 0) {
            const symbol = globalTickerList[tickerPointer];
            const data = await getQuote(symbol);
            if (data) updateUIDisplay(symbol, data);
            
            tickerPointer = (tickerPointer + 1) % globalTickerList.length;
            document.getElementById("last-update").textContent = `LST UPD: ${symbol}`;
            setStatus(`SYNC OK [${tickerPointer}/${globalTickerList.length}]`);
        }
        await sleep(CALL_DELAY_MS);
    }
}

// ─────────────────────────────────────────────────────────
// START
// ─────────────────────────────────────────────────────────
buildChrome();
refreshStructure().then(() => {
    startLoop();
    setInterval(refreshStructure, 600000); 
});

// Arrow Navigation
document.addEventListener("keydown", e => {
    const tabs = document.querySelectorAll(".tab");
    const current = [...tabs].findIndex(t => t.classList.contains("active"));
    if (e.key === "ArrowLeft" && current > 0) switchPage(current - 1);
    if (e.key === "ArrowRight" && current < tabs.length - 1) switchPage(current + 1);
});
</script>
</body>
</html>
