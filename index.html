<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Bloomberg Lite</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; background: #0a0a0a; color: #00ffcc; font-family: monospace; font-size: 13px; overflow: hidden; }
        .header { flex-shrink: 0; display: flex; align-items: center; color: orange; padding: 6px 12px; border-bottom: 1px solid #333; background: #111; }
        .header-title { font-size: 14px; font-weight: bold; letter-spacing: 2px; }
        .header-time  { color: #888; font-size: 11px; margin-left: auto; }
        .tabs { flex-shrink: 0; display: flex; gap: 2px; padding: 4px 12px; background: #111; border-bottom: 1px solid #333; overflow-x: auto; white-space: nowrap; }
        .tab { flex-shrink: 0; padding: 3px 14px; cursor: pointer; border: 1px solid #444; color: #888; background: transparent; font-family: monospace; font-size: 11px; }
        .tab.active { border-color: orange; color: orange; background: rgba(255,165,0,.08); }
        
        #pages { flex: 1; position: relative; height: 100%; }
        .page { display: none; position: absolute; inset: 0; padding: 0 6px; flex-direction: row; }
        .page.active { display: flex; }
        .col { flex: 1; border-right: 1px solid #1a1a1a; height: 100%; overflow: hidden; }
        .col:last-child { border-right: none; }
        
        /* ADJUSTED: Taller headers and rows for better legibility */
        .group { color: orange; height: 46px; display: flex; align-items: flex-end; padding: 0 0 6px 3px; font-size: 12px; font-weight: bold; text-transform: uppercase; border-bottom: 1px solid #1e1e1e; white-space: nowrap; }
        .row { display: grid; grid-template-columns: 52px 105px 65px 55px 55px 25px; height: 24px; line-height: 24px; padding: 0 3px; border-bottom: 1px solid #0f0f0f; align-items: center; gap: 3px; }
        .row:hover { background: #141414; }
        
        .cell-ticker a { font-weight: bold; color: #ffb300; text-decoration: none; }
        .cell-ticker a:hover { color: #00ffcc; text-decoration: underline; }
        .cell-name { color: #ffb300; font-size: 10px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; opacity: 0.85; }
        .cell-price, .cell-chg, .cell-pct, .cell-age { text-align: right; font-size: 12px; }
        .cell-age { font-size: 9px; color: #ffb300; opacity: 0.6; }
        .green { color: #00e676; }
        .red { color: #ff5252; }
        .statusbar { flex-shrink: 0; background: #111; border-top: 1px solid #222; padding: 2px 12px; font-size: 10px; color: #555; display: flex; gap: 16px; height: 22px; align-items: center; }
    </style>
</head>
<body style="display: flex; flex-direction: column;">

<div class="header">
    <div class="header-title">â—† BLOOMBERG LITE</div>
    <div class="header-time" id="clock"></div>
</div>
<div class="tabs" id="tabs"></div>
<div id="pages"></div>
<div class="statusbar">
    <span id="status">CONNECTING...</span>
    <span id="counter"></span>
</div>

<script>
const API_KEY = "d6atqi1r01qnr27isiq0d6atqi1r01qnr27isiqg";
const CALL_DELAY = 1200;
const NUM_COLS = 5;
const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT46q9pwRZMT27tLH6taYNgIYXFPkLdnjOhv3KqqGJGJY_Dn1SJ6yI4v1jaODaHy33TwbM-L5z14UWF/pub?gid=0&single=true&output=csv";

let masterList = [];
let tickerMeta = {};
let quoteStore = {};
let numPages = 0;

function parseCSVLine(line) {
    const result = [];
    let cur = "";
    let inQuotes = false;
    for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (char === '"') { inQuotes = !inQuotes; }
        else if (char === ',' && !inQuotes) { result.push(cur.trim()); cur = ""; }
        else { cur += char; }
    }
    result.push(cur.trim());
    return result;
}

function updateClock() {
    const now = new Date();
    document.getElementById("clock").textContent = now.toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric"}) + "  " + now.toLocaleTimeString("en-US",{hour12:false});
    masterList.forEach(t => {
        if (quoteStore[t]) {
            const safeId = t.replace(/[^a-zA-Z0-9]/g, '-');
            const ageEl = document.getElementById(`age-${safeId}`);
            if (ageEl) {
                const s = Math.floor((Date.now() - quoteStore[t].ts) / 1000);
                ageEl.textContent = s < 60 ? s + "s" : Math.floor(s/60) + "m";
            }
        }
    });
}
setInterval(updateClock, 1000);

async function init() {
    try {
        const resp = await fetch(SHEET_URL);
        const text = await resp.text();
        const lines = text.trim().split(/\r?\n/);
        const rows = lines.map(line => parseCSVLine(line));
        
        const allItems = [];
        const maxColsAvailable = Math.max(...rows.map(r => r.length));
        
        for (let b = 0; b < maxColsAvailable; b += 3) {
            let activeGroup = "";
            rows.forEach(row => {
                const colA = (row[b] || "");
                const colB = (row[b+1] || "");
                const colC = (row[b+2] || "");

                if (colA && !colB) { activeGroup = colA; } 
                else if (colB && colB.toLowerCase() !== "ticker") {
                    const currentGroup = colA || activeGroup || "UNCLASSIFIED";
                    if (colA) activeGroup = colA; 

                    if (colB.length < 12 && !colB.includes(" ")) {
                        allItems.push({ group: activeGroup, ticker: colB.toUpperCase(), name: colC });
                    }
                }
            });
        }

        const pagesContainer = document.getElementById("pages");
        const colH = pagesContainer.offsetHeight || 800;
        
        // NEW PRECISION CALC: Use 24px per row + 46px per group header
        const slotsPerCol = Math.floor((colH - 24) / 24); 

        let curP = 0, curC = 0, curS = 0, lastG = "";
        allItems.forEach(item => {
            const isNewG = item.group !== lastG;
            // A header (46px) is roughly 2 rows (24px * 2 = 48px)
            const cost = isNewG ? 2 : 1;
            
            if (curS + cost > slotsPerCol) {
                curC++;
                if (curC >= NUM_COLS) { curP++; curC = 0; }
                curS = 0;
                tickerMeta[item.ticker] = { ...item, pIdx: curP, cIdx: curC, showH: true };
                curS = 2;
            } else {
                tickerMeta[item.ticker] = { ...item, pIdx: curP, cIdx: curC, showH: isNewG };
                curS += cost;
            }
            if (!masterList.includes(item.ticker)) masterList.push(item.ticker);
            lastG = item.group;
        });

        numPages = curP + 1;
        renderUI();
        rollingLoop();
    } catch (err) {
        document.getElementById("status").textContent = "CSV ERROR";
    }
}

function renderUI() {
    const tEl = document.getElementById("tabs"), pEl = document.getElementById("pages");
    tEl.innerHTML = ""; pEl.innerHTML = "";
    for (let i = 0; i < numPages; i++) {
        const btn = document.createElement("button");
        btn.className = "tab" + (i===0?" active":"");
        btn.textContent = `PAGE ${i+1}`;
        btn.onclick = () => {
            document.querySelectorAll(".tab, .page").forEach(el => el.classList.remove("active"));
            btn.classList.add("active");
            document.getElementById(`page-${i}`).classList.add("active");
        };
        tEl.appendChild(btn);
        const pg = document.createElement("div");
        pg.className = "page" + (i===0?" active":"");
        pg.id = `page-${i}`;
        for (let c = 0; c < NUM_COLS; c++) {
            const col = document.createElement("div");
            col.className = "col";
            col.id = `col-${i}-${c}`;
            pg.appendChild(col);
        }
        pEl.appendChild(pg);
    }
    masterList.forEach(t => {
        const m = tickerMeta[t];
        const col = document.getElementById(`col-${m.pIdx}-${m.cIdx}`);
        if (!col) return;
        if (m.showH) {
            const g = document.createElement("div");
            g.className = "group"; g.textContent = m.group;
            col.appendChild(g);
        }
        const r = document.createElement("div");
        const safeId = t.replace(/[^a-zA-Z0-9]/g, '-');
        r.className = "row"; r.id = `row-${safeId}`;
        r.innerHTML = `
            <div class="cell-ticker"><a href="https://finance.yahoo.com/quote/${t}" target="_blank">${t}</a></div>
            <div class="cell-name">${m.name}</div>
            <div class="cell-price">...</div>
            <div class="cell-chg">...</div>
            <div class="cell-pct">...</div>
            <div class="cell-age" id="age-${safeId}"></div>`;
        col.appendChild(r);
    });
}

async function rollingLoop() {
    let i = 0;
    while(true) {
        const t = masterList[i];
        const safeId = t.replace(/[^a-zA-Z0-9]/g, '-');
        document.getElementById("status").textContent = `FETCH: ${t}`;
        document.getElementById("counter").textContent = `${i+1}/${masterList.length}`;
        try {
            const r = await fetch(`https://finnhub.io/api/v1/quote?symbol=${t}&token=${API_KEY}`);
            if (r.status === 429) { await new Promise(ok => setTimeout(ok, 3000)); continue; }
            const d = await r.json();
            if (d.c && d.c !== 0) {
                const up = d.d >= 0;
                quoteStore[t] = { ts: Date.now() };
                const row = document.getElementById(`row-${safeId}`);
                if (row) {
                    row.className = `row ${up?'green':'red'}`;
                    row.querySelector(".cell-price").textContent = d.c.toFixed(2);
                    row.querySelector(".cell-chg").textContent = (up?'+':'')+d.d.toFixed(2);
                    row.querySelector(".cell-pct").textContent = (up?'+':'')+d.dp.toFixed(2)+'%';
                }
            }
        } catch(e) {}
        await new Promise(ok => setTimeout(ok, CALL_DELAY));
        i = (i + 1) % masterList.length;
    }
}

document.addEventListener("keydown", e => {
    const tabs = document.querySelectorAll(".tab");
    let cur = [...tabs].findIndex(t => t.classList.contains("active"));
    if (e.key === "ArrowRight") { cur = (cur + 1) % numPages; tabs[cur].click(); }
    if (e.key === "ArrowLeft") { cur = (cur - 1 + numPages) % numPages; tabs[cur].click(); }
});

init();
</script>
</body>
</html>
